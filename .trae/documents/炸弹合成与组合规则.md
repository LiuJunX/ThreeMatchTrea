# 炸弹合成需求说明（含图示）

本文件为详细的需求文档，定义炸弹的类型、生成与合成规则、触发与清除范围、随机与优先级策略，以及规范性的图示说明。该文档不作为代码参考，而是规范实现目标与测试覆盖的依据。

## 名词与约定
- 棋盘坐标：左上角为 (0,0)，X 向右递增，Y 向下递增
- 颜色记号：R/G/B/Y/P/O 表示红/绿/蓝/黄/紫/橙；_ 表示空
- 炸弹类型：Horizontal（行炸弹）、Vertical（列炸弹）、Ufo（目标定消）、Square3x3（3x3）、Color（彩虹）
- 炸弹原点：合成后炸弹生成的具体格子（通常是交换焦点）
- 半径 r 区域：以中心为矩形范围，坐标满足 |dx|≤r 且 |dy|≤r

## 生成规则（规范）
- 3 连不生成炸弹
- 4 连：
  - 若匹配聚合区域宽度 > 高度 → 生成 Vertical（列炸弹）
  - 否则 → 生成 Horizontal（行炸弹）
- 炸弹原点选择：
  - 若交换焦点在匹配集合内 → 原点为交换焦点
  - 否则 → 原点为匹配集合的中位位置

图示：4 连（横向）生成 Vertical（列炸弹）

```
_ _ _ _ _ _ _ _
R R R R _ _ _ 
_ _ _ _ _ _ _ _
_ _ _ _ _ _ _ _
```

炸弹类型：Vertical
原点：见“炸弹原点规则”

图示：直线（横向） 5 连生成 Color（彩虹）

```
_ _ _ _ _ _ _ _
R R R R R _ _ _
_ _ _ _ _ _ _ _
_ _ _ _ _ _ _ _
```

图示：直线（竖向） 5 连生成 Color（彩虹）

```
_ _ _ _ R _ _ _
_ _ _ _ R _ _ _
_ _ _ _ R _ _ _
_ _ _ _ R _ _ _
_ _ _ _ R _ _ _
```

炸弹类型：Color（彩虹）
原点：见“炸弹原点规则”

图示：T 形 5 连生成 Ufo

```
_ _ _ _ _ _ _ _
_ R _ _ _ _ _ _
R R R _ _ _ _ _
_ R _ _ _ _ _ _
```

炸弹类型：Ufo（目标定消）
原点：见“炸弹原点规则”

图示：2×3 的 6 连（非直线）生成 Square3x3

```
_ _ _ _ _ _ _ _
_ _ R _ _ _ _ _
_ _ R _ _ _ _ _
_ _ R R R _ _ _
```

炸弹类型：Square3x3（3×3）
原点：见“炸弹原点规则”

## 单炸弹行为（规范）
- Horizontal：清除所在“行”全部格子
- Vertical：清除所在“列”全部格子
- Square3x3：清除以自身为中心的 3×3 矩形格
- Ufo：从棋盘中随机选择一个“非空且非自身”的目标格，清除该格；若无候选则不清除
- Color：作为单体时仅清除自身；与其他对象组合时触发特定规则（见下）

Ufo 目标选择（规范）：
- 候选集合：棋盘上所有类型≠None 的格，排除自身
- 选择策略：等概率随机；若需确定性可由统一随机源驱动
- 后续扩展（可选）：优先级（障碍/任务）、距离最近、指定颜色等

## 合成（组合）规则（规范）
- 线炸弹 + 线炸弹（Horizontal/Vertical 任意两者）：
  - 效果：同时清除“交换目标位置所在的行与列”（一个十字）
- 其他任意炸弹组合（包含 Ufo、Square 与线炸弹的任意组合）：
  - 效果：以“交换目标位置”为中心的半径 2 区域清除（5×5 矩形，边界裁剪）
- 组合后两颗炸弹均被消耗（变为空）

组合图示：线 + 线（行列十字）

```
_ _ _ _ _ _ _ _
_ _ _ _ _ _ _ _
_ _ H V _ _ _ _
_ _ _ _ _ _ _ _
```

组合效果：所在行 + 所在列全清（以合成中心为十字）
合成中心：见“合成中心规则”

组合图示：Ufo + 线 / Ufo + Square3x3 / Square3x3 + 线（半径 2）

```
示意（C 为交换目标中心，x 为清除范围）：
_ _ _ _ _ _ _ _
_ _ _ x x x _ _
_ _ _ x C x _ _
_ _ _ x x x _ _
_ _ _ _ _ _ _ _

边界外裁剪
```

## 彩虹组合（规范）
- 彩虹 + 彩虹：清空全盘
- 彩虹 + 普通颜色：清除该颜色所有格
- 彩虹 + 炸弹（对方为某颜色且带炸弹标记）：
  - 先将该颜色所有格“转化”为该炸弹类型
  - 再对这些格按对应炸弹类型逐个执行爆炸效果
- 两个参与组合的单元均被消耗（清空）

图示：彩虹 + 颜色

```
_ _ _ _ _ _ _ _
_ _ _ C R _ _ _
_ _ _ _ R _ _ _
R _ _ _ _ _ _ _
```

组合效果：清除所有 R（变为 _）
合成中心：见“合成中心规则”

图示：彩虹 + 炸弹（以 Vertical 为例）

```
_ _ _ _ _ _ _ _
_ _ _ C R _ _ _
_ _ _ _ R _ _ _
R _ _ _ _ _ _ _
```

组合效果：
- 转化：所有红色格 → 赋予 Vertical 标记（示意保留 R）
- 爆炸：对所有红色格按 Vertical 执行整列清除
- 两参与格清空；多列被清除为 _

## 冲突与优先级（规范）
- 同步出现多组匹配时：
  - 先按合成原点的交换焦点归属判断炸弹原点
  - 多炸弹生成时，分别以各自原点落地（允许同帧多炸弹）
- 组合触发优先于普通匹配触发（当交换双方均为特殊或含彩虹时）
- 重力与补充在每轮清除后统一执行（自上而下补充、自下而上下落）

## 记分（范围外）
- 记分标准不在本文范围；具体分值可由关卡/经济系统另行定义

## 图示说明规范
- 仅使用网格文本表示，不展示交换步骤
- 网格中的炸弹标记采用单字符：H（Horizontal）、V（Vertical）、U（Ufo）、S（Square3x3）、C（Color）
- 清除范围在说明文字中描述（十字或半径矩形），无需边框

## 测试覆盖建议（说明）
- 为每条生成与组合规则至少提供 1 个场景
- 复杂合成（T/L/≥6）提供多布局变体
- 彩虹组合覆盖四类炸弹与同类彩虹
- 交换触发与非触发（无匹配回滚）均覆盖
