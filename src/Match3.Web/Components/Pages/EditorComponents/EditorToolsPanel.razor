@using Match3.Editor.ViewModels
@using Match3.Core.Models.Enums
@using Match3.Core.Models.Grid
@inject LevelEditorViewModel VM

<aside class="bg-light border-start d-flex flex-column" style="width: 280px; min-width: 280px; overflow-y: auto;">
    <div class="p-3 border-bottom">
        <h6 class="text-uppercase text-muted small fw-bold mb-3">Palette</h6>
        <div class="d-grid gap-2" style="grid-template-columns: repeat(4, 1fr);">
            @foreach (var type in VM.TilePaletteTypes)
            {
                <button class="btn p-0 border position-relative @(VM.SelectedType == type ? "border-primary border-3" : "")"
                        style="height: 48px; background: @LevelEditorViewModel.GetTileBackground(type); box-shadow: @(VM.SelectedType == type ? "inset 0 0 0 1px rgba(255,255,255,0.5)" : "none")"
                        @onclick="() => VM.SelectedType = type"
                        title="@type">
                    @if (VM.SelectedType == type)
                    {
                        <span class="position-absolute top-50 start-50 translate-middle small @LevelEditorViewModel.GetTileCheckmarkClass(type)">âœ“</span>
                    }
                </button>
            }
        </div>
    </div>

    <div class="p-3 border-bottom">
        <h6 class="text-uppercase text-muted small fw-bold mb-3">Items / Bombs</h6>
        <div class="d-grid gap-2" style="grid-template-columns: repeat(3, 1fr);">
            @foreach (var bomb in (BombType[])Enum.GetValues(typeof(BombType)))
            {
                <button class="btn btn-outline-secondary p-1 d-flex flex-column align-items-center justify-content-center @(VM.SelectedBomb == bomb ? "active" : "")"
                        style="height: 60px;"
                        @onclick="() => VM.SelectedBomb = bomb"
                        title="@bomb">
                    <span class="fs-4">@GetBombIcon(bomb)</span>
                    <span style="font-size: 10px;">@bomb</span>
                </button>
            }
        </div>
    </div>

    <div class="flex-grow-1 p-3">
        <h6 class="text-uppercase text-muted small fw-bold mb-3">Data IO</h6>
        
        <div class="btn-group w-100 mb-2">
            <button class="btn btn-primary btn-sm" @onclick="VM.SaveScenarioAsync" disabled="@string.IsNullOrEmpty(VM.CurrentFilePath)">
                <i class="bi bi-save"></i> Save
            </button>
            <button class="btn btn-success btn-sm" @onclick="VM.ExportJson">Export</button>
            <button class="btn btn-warning btn-sm" @onclick="() => VM.ImportJson(false)">Import</button>
        </div>
        
        <textarea class="form-control form-control-sm font-monospace small" rows="8" @bind="VM.JsonOutput" style="white-space: pre; overflow-x: auto;"></textarea>
    </div>
</aside>

@implements IDisposable

@code {
    protected override void OnInitialized()
    {
        VM.PropertyChanged += OnVmPropertyChanged;
    }

    private void OnVmPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        VM.PropertyChanged -= OnVmPropertyChanged;
    }
    private string GetBombIcon(BombType bomb) => bomb switch
    {
        BombType.None => "",
        BombType.Horizontal => "â†”ï¸",
        BombType.Vertical => "â†•ï¸",
        BombType.Ufo => "ðŸ›¸",
        BombType.Square5x5 => "ðŸ’£",
        BombType.Color => "ðŸŒˆ",
        _ => ""
    };
}
