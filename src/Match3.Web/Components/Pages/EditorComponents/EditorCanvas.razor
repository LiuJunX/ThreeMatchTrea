@using Match3.Editor.ViewModels
@using Match3.Editor.Logic
@using Match3.Editor.Helpers
@using Match3.Core.Models.Enums
@using Match3.Core.Models.Grid
@using Match3.Core.Scenarios
@inject LevelEditorViewModel VM
@implements IDisposable

<main class="flex-grow-1 bg-secondary bg-opacity-10 d-flex flex-column position-relative overflow-hidden">
    <!-- Toolbar Overlay -->
    <div class="position-absolute top-0 start-50 translate-middle-x mt-3 bg-white shadow-sm rounded-pill px-3 py-1 d-flex gap-3 align-items-center z-index-10 border" style="z-index: 100;">
        <div class="small fw-bold text-muted">
            @if(VM.IsAssertionMode) { <span>üéØ VERIFYING</span> }
            else { <span>‚úèÔ∏è EDITING @VM.ActiveLayer.ToString().ToUpper()</span> }
        </div>
        <div class="vr"></div>
        <div class="small text-muted">@VM.ActiveLevelConfig.Width x @VM.ActiveLevelConfig.Height</div>
    </div>

    <!-- Level Analysis Panel (Top Right) -->
    @if (VM.CurrentMode == EditorMode.Level)
    {
        <div class="position-absolute top-0 end-0 m-3 bg-white shadow rounded p-2" style="z-index: 100; min-width: 160px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-uppercase text-muted small fw-bold">Analysis</span>
                @if (VM.IsAnalyzing)
                {
                    <span class="badge bg-primary">@VM.AnalysisProgressText</span>
                }
            </div>

            <div class="d-flex gap-3 small">
                <div class="text-center">
                    <div class="text-muted" style="font-size: 0.7rem;">Win</div>
                    <div class="fw-bold @GetWinRateClass(VM.WinRate)">@(VM.WinRate.ToString("P0"))</div>
                </div>
                <div class="text-center">
                    <div class="text-muted" style="font-size: 0.7rem;">Dead</div>
                    <div class="fw-bold text-danger">@(VM.DeadlockRate.ToString("P0"))</div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(VM.DifficultyText))
            {
                <div class="text-center mt-1 small text-muted" style="font-size: 0.7rem;">
                    @VM.DifficultyText
                </div>
            }

            <button class="btn btn-sm btn-outline-primary w-100 mt-2 py-0" style="font-size: 0.75rem;" @onclick="VM.RestartAnalysis" disabled="@VM.IsAnalyzing">
                <i class="bi bi-arrow-repeat"></i> Analyze
            </button>
        </div>
    }

    <!-- Grid Container -->
    <div class="flex-grow-1 d-flex align-items-center justify-content-center overflow-auto p-5">
        @{
            var currentConfig = VM.ActiveLevelConfig;
            var width = currentConfig.Width;
            var height = currentConfig.Height;
            var tileSize = 60;
        }
        <div class="position-relative shadow-lg bg-white" 
             style="width: @(width * tileSize)px; height: @(height * tileSize)px; border: 10px solid @(VM.IsAssertionMode ? "#ffc107" : "#fff"); border-radius: 4px;"
             @onmouseleave="StopDrawing"
             @onmouseup="StopDrawing">
            
            @for (int i = 0; i < currentConfig.Grid.Length; i++)
            {
                var index = i;
                var x = i % width;
                var y = i / width;
                
                var displayType = VM.ActiveLevelConfig.Grid[index];
                var displayBomb = index < VM.ActiveBombs.Length ? VM.ActiveBombs[index] : BombType.None;
                var displayGround = (VM.ActiveLevelConfig.Grounds != null && index < VM.ActiveLevelConfig.Grounds.Length) 
                    ? VM.ActiveLevelConfig.Grounds[index] 
                    : GroundType.None;
                var displayCover = (VM.ActiveLevelConfig.Covers != null && index < VM.ActiveLevelConfig.Covers.Length) 
                    ? VM.ActiveLevelConfig.Covers[index] 
                    : CoverType.None;

                // Parent div is now just a container/background
                <div class="position-absolute border border-light"
                     style="left: @(x * tileSize)px; top: @(y * tileSize)px; width: @(tileSize)px; height: @(tileSize)px; background-color: #f8f9fa; cursor: @(VM.IsAssertionMode ? "crosshair" : "pointer");"
                     @onmousedown="() => StartDrawing(index)"
                     @onmouseenter="() => PaintTile(index)"
                     @ondragstart:preventDefault="true">

                    <!-- Ground Layer (Z=1) -->
                    @if (displayGround != GroundType.None)
                    {
                         <div class="position-absolute top-0 start-0 w-100 h-100" 
                              style="z-index: 1; background: @EditorStyleHelper.GetGroundColor(displayGround); opacity: 0.8;">
                            <span class="position-absolute bottom-0 end-0 small text-muted p-1" style="font-size:9px; line-height:1;">@displayGround.ToString()[0]</span>
                         </div>
                    }

                    <!-- Tile Layer (Z=2) -->
                    <div class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center" style="z-index: 2; pointer-events: none;">
                        <div class="rounded-circle shadow-sm"
                             style="width: 75%; height: 75%; background-color: @EditorStyleHelper.GetTileColorForCanvas(displayType); box-shadow: inset 0 -2px 4px rgba(0,0,0,0.2); transition: transform 0.1s;">
                            
                            @if (displayBomb != BombType.None)
                            {
                                <div class="w-100 h-100 d-flex align-items-center justify-content-center">
                                    <span class="fs-4" style="filter: drop-shadow(0 0 2px white);">
                                        @EditorStyleHelper.GetBombIcon(displayBomb)
                                    </span>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Cover Layer (Z=3) -->
                    @if (displayCover != CoverType.None)
                    {
                        <div class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center" 
                             style="z-index: 3; background-color: rgba(255,255,255,0.3); border: 2px solid rgba(0,0,0,0.1); pointer-events: none;">
                            <span class="fs-4 fw-bold" style="text-shadow: 0 0 3px white;">
                                @EditorStyleHelper.GetCoverIcon(displayCover)
                            </span>
                        </div>
                    }

                    <!-- Scenario Assertion Overlay -->
                    @if (VM.CurrentMode == EditorMode.Scenario)
                    {
                        var assertion = VM.CurrentScenario.Assertions.FirstOrDefault(a => a.X == x && a.Y == y);
                        if (assertion != null)
                        {
                            <div class="position-absolute top-0 start-0 w-100 h-100 border border-3 border-warning" style="z-index: 6; pointer-events: none;">
                                <div class="position-absolute bottom-0 end-0 bg-warning text-dark px-1 small" style="font-size: 10px; opacity: 0.9;">
                                    @(assertion.Type.HasValue ? assertion.Type.Value.ToString().Substring(0,1) : "*")
                                    @(assertion.Bomb.HasValue ? "üí£" : "")
                                </div>
                            </div>
                        }
                    }
                </div>
            }
        </div>
    </div>
</main>

@code {
    private bool IsDrawing { get; set; } = false;

    protected override void OnInitialized()
    {
        VM.OnRequestRepaint += RequestUpdate;
    }

    private void RequestUpdate()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnVmPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private void StartDrawing(int index)
    {
        VM.HandleGridClick(index);

        if (!VM.IsAssertionMode)
        {
            IsDrawing = true;
        }
    }

    private void PaintTile(int index)
    {
        if (IsDrawing && !VM.IsAssertionMode)
        {
            VM.PaintAt(index);
        }
    }

    private void StopDrawing()
    {
        IsDrawing = false;
    }

    public void Dispose()
    {
        VM.OnRequestRepaint -= RequestUpdate;
        VM.PropertyChanged -= OnVmPropertyChanged;
    }

    private static string GetWinRateClass(float winRate) => winRate switch
    {
        >= 0.8f => "text-success",
        >= 0.6f => "text-info",
        >= 0.4f => "text-warning",
        _ => "text-danger"
    };
}
