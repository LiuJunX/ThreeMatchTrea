@page "/level-editor"
@using Match3.Editor.ViewModels
@using Match3.Web.Components.Pages.EditorComponents
@inject LevelEditorViewModel VM
@inject LevelAIChatViewModel ChatVM
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Level Editor</PageTitle>

<div class="d-flex flex-column vh-100 overflow-hidden" style="max-height: 100vh;">
    <!-- Header -->
    <EditorHeader />

    <div class="flex-grow-1 d-flex overflow-hidden">
        <!-- LEFT SIDEBAR: Configuration -->
        <EditorConfigPanel />

        <!-- CENTER: Canvas -->
        <EditorCanvas />

        <!-- RIGHT SIDEBAR: Tools -->
        <EditorToolsPanel />
    </div>
</div>

<!-- AI Chat Panel (Floating) -->
<AIChatPanel OnRepaintRequested="OnAIRepaintRequested" />

@code {
    protected override void OnInitialized()
    {
        VM.PropertyChanged += OnVmPropertyChanged;
        ChatVM.PropertyChanged += OnVmPropertyChanged;
        VM.RefreshScenarioList();
        VM.RefreshLevelList();
    }

    private void OnVmPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnAIRepaintRequested()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        VM.PropertyChanged -= OnVmPropertyChanged;
        ChatVM.PropertyChanged -= OnVmPropertyChanged;
    }
}
