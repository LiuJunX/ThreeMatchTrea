@page "/level-editor"
@using Match3.Editor.ViewModels
@using Match3.Web.Components.Pages.EditorComponents
@inject LevelEditorViewModel VM
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Level Editor</PageTitle>

<div class="d-flex flex-column vh-100 overflow-hidden" style="max-height: 100vh;">
    <!-- Header -->
    <EditorHeader />

    <div class="flex-grow-1 d-flex overflow-hidden">
        <!-- LEFT SIDEBAR: Configuration -->
        <EditorConfigPanel />

        <!-- CENTER: Canvas -->
        <EditorCanvas />

        <!-- RIGHT SIDEBAR: Tools -->
        <EditorToolsPanel />
    </div>
</div>

@code {
    private System.Threading.Timer? _timer;

    protected override void OnInitialized()
    {
        // Subscribe to VM changes to handle mode switching and other updates
        VM.PropertyChanged += OnVmPropertyChanged;

        // Initial load of scenario tree
        VM.RefreshScenarioList();
        
        // Timer for simulation loop
        _timer = new System.Threading.Timer(OnTimerTick, null, 16, 16);
    }

    private void OnVmPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnTimerTick(object? state)
    {
        if (VM.IsRecording)
        {
            VM.UpdateSimulation(0.016f);
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        VM.PropertyChanged -= OnVmPropertyChanged;
        _timer?.Dispose();
    }
}
