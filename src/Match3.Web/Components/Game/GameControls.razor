@using Match3.Web.Services
@using Match3.Editor.Interfaces
@using Match3.Core.Config
@inject Match3GameService GameService
@inject ScenarioLibraryService ScenarioService
@inject IJsonService JsonService
@implements IDisposable

<div class="controls">
    <div class="mb-3">
        <label class="form-label fw-bold text-secondary small">SCENARIOS</label>
        <select class="form-select" @onchange="OnScenarioChanged">
            <option value="">Random Level</option>
            @foreach (var scenario in Scenarios)
            {
                <option value="@scenario.RelativePath">@scenario.Name</option>
            }
        </select>
    </div>

    <button @onclick="ResetGame" class="btn-reset">New Game</button>
    <button @onclick="ToggleAutoPlay" class="btn-reset" style="margin-left: 10px; background-color: #3b82f6;">
        @(GameService.IsAutoPlaying ? "Stop Auto" : "Auto Play")
    </button>
    <div style="margin-top: 15px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
        <label for="speedSlider" style="font-weight: 600; color: #4b5563;">Game Speed: @GameService.GameSpeed.ToString("0.0")x</label>
        <input id="speedSlider" type="range" min="0.1" max="5.0" step="0.1" @bind="GameService.GameSpeed" @bind:event="oninput" style="width: 200px; cursor: pointer;" />
    </div>

    @if (GameService.Config != null)
    {
        <div class="gravity-settings" style="margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
            <label class="form-label fw-bold text-secondary small">GRAVITY SETTINGS</label>

            <div style="margin-top: 10px;">
                <label style="font-size: 12px; color: #6b7280;">Initial Speed: @GameService.Config.InitialFallSpeed.ToString("0.0")</label>
                <input type="range" min="0" max="20" step="0.5"
                       value="@GameService.Config.InitialFallSpeed"
                       @oninput="OnInitialSpeedChanged"
                       style="width: 100%;" />
            </div>

            <div style="margin-top: 8px;">
                <label style="font-size: 12px; color: #6b7280;">Gravity: @GameService.Config.GravitySpeed.ToString("0.0")</label>
                <input type="range" min="0" max="50" step="1"
                       value="@GameService.Config.GravitySpeed"
                       @oninput="OnGravitySpeedChanged"
                       style="width: 100%;" />
            </div>

            <div style="margin-top: 8px;">
                <label style="font-size: 12px; color: #6b7280;">Max Speed: @GameService.Config.MaxFallSpeed.ToString("0.0")</label>
                <input type="range" min="5" max="50" step="1"
                       value="@GameService.Config.MaxFallSpeed"
                       @oninput="OnMaxSpeedChanged"
                       style="width: 100%;" />
            </div>

            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn btn-sm btn-outline-secondary" @onclick="ApplyPreset_Candy">Candy Style</button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="ApplyPreset_Physics">Physics</button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="ApplyPreset_Fast">Fast</button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="ApplyPreset_Default">Default</button>
            </div>
        </div>
    }
</div>

@code {
    private List<Match3.Editor.ViewModels.ScenarioFileEntry> Scenarios = new();
    private string SelectedScenarioPath = "";

    protected override void OnInitialized()
    {
        GameService.OnChange += StateHasChanged;
        LoadScenarios();
    }

    private void LoadScenarios()
    {
        // Load all scenarios flattened
        Scenarios = ScenarioService.SearchFiles("").OrderBy(s => s.Name).ToList();
    }

    private void OnScenarioChanged(ChangeEventArgs e)
    {
        SelectedScenarioPath = e.Value?.ToString() ?? "";
    }

    public void Dispose()
    {
        GameService.OnChange -= StateHasChanged;
    }

    private void ResetGame()
    {
        LevelConfig? config = null;
        if (!string.IsNullOrEmpty(SelectedScenarioPath))
        {
            try
            {
                var json = ScenarioService.ReadScenarioJson(SelectedScenarioPath);
                // Try to parse as ScenarioConfig first, if fails or no Operations, treat as LevelConfig?
                // Actually the files are likely ScenarioConfig JSONs.
                // But Match3GameService.StartNewGame expects LevelConfig.
                // We need to extract InitialState from ScenarioConfig.
                
                // Assuming the JSON structure matches ScenarioConfig or LevelConfig
                // Let's try to parse as ScenarioConfig first
                if (json.Contains("Operations"))
                {
                    var scenario = JsonService.Deserialize<ScenarioConfig>(json);
                    config = scenario.InitialState;
                }
                else
                {
                    // Fallback or direct LevelConfig
                     config = JsonService.Deserialize<LevelConfig>(json);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to load scenario: {ex.Message}");
            }
        }
        
        GameService.StartNewGame(config);
    }
    
    private void ToggleAutoPlay() => GameService.ToggleAutoPlay();

    // Gravity slider handlers
    private void OnInitialSpeedChanged(ChangeEventArgs e)
    {
        if (GameService.Config != null && float.TryParse(e.Value?.ToString(), out var value))
            GameService.Config.InitialFallSpeed = value;
    }

    private void OnGravitySpeedChanged(ChangeEventArgs e)
    {
        if (GameService.Config != null && float.TryParse(e.Value?.ToString(), out var value))
            GameService.Config.GravitySpeed = value;
    }

    private void OnMaxSpeedChanged(ChangeEventArgs e)
    {
        if (GameService.Config != null && float.TryParse(e.Value?.ToString(), out var value))
            GameService.Config.MaxFallSpeed = value;
    }

    // Gravity presets
    private void ApplyPreset_Candy()
    {
        if (GameService.Config == null) return;
        GameService.Config.InitialFallSpeed = 10.0f;
        GameService.Config.GravitySpeed = 15.0f;
        GameService.Config.MaxFallSpeed = 20.0f;
    }

    private void ApplyPreset_Physics()
    {
        if (GameService.Config == null) return;
        GameService.Config.InitialFallSpeed = 0.0f;
        GameService.Config.GravitySpeed = 20.0f;
        GameService.Config.MaxFallSpeed = 30.0f;
    }

    private void ApplyPreset_Fast()
    {
        if (GameService.Config == null) return;
        GameService.Config.InitialFallSpeed = 15.0f;
        GameService.Config.GravitySpeed = 25.0f;
        GameService.Config.MaxFallSpeed = 40.0f;
    }

    private void ApplyPreset_Default()
    {
        if (GameService.Config == null) return;
        GameService.Config.InitialFallSpeed = 12.0f;
        GameService.Config.GravitySpeed = 20.0f;
        GameService.Config.MaxFallSpeed = 25.0f;
    }
}
