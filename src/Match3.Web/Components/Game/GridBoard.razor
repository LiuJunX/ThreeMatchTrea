@using Match3.Core
@using Match3.Core.Models.Grid
@using Match3.Core.Models.Enums
@using Match3.Web.Services
@using Match3.Presentation
@using System.Numerics
@using System.Globalization

@if (GameService.VisualState != null)
{
    <div class="board-wrapper">
        <div class="board-container"
             style="width: @(GameService.Width * Match3GameService.CellSize)px; height: @(GameService.Height * Match3GameService.CellSize)px;"
             @onpointerup="HandlePointerUp">
            <!-- Background Grid -->
            @for (int y = 0; y < GameService.Height; y++)
            {
                @for (int x = 0; x < GameService.Width; x++)
                {
                    var px = x;
                    var py = y;
                    <div class="cell-bg"
                         style="left: @(x * Match3GameService.CellSize)px; top: @(y * Match3GameService.CellSize)px;"
                         @onpointerdown="e => HandlePointerDown(e, px, py)"
                         @onpointerup="HandlePointerUp">
                    </div>
                }
            }

            <!-- Ground Layer -->
            @if (GameService.SimulationEngine != null)
            {
                @for (int y = 0; y < GameService.Height; y++)
                {
                    @for (int x = 0; x < GameService.Width; x++)
                    {
                        var ground = GameService.SimulationEngine.State.GetGround(x, y);
                        @if (ground.Type != GroundType.None)
                        {
                            <div class="ground-layer ground-@ground.Type.ToString().ToLower()"
                                 style="left: @(x * Match3GameService.CellSize)px; top: @(y * Match3GameService.CellSize)px;">
                                <span class="ground-hp">@ground.Health</span>
                            </div>
                        }
                    }
                }
            }

            <!-- Active Tiles from VisualState -->
            @foreach (var kvp in GameService.VisualState.Tiles)
            {
                var visual = kvp.Value;
                @if (visual.IsVisible && visual.Alpha > 0.01f)
                {
                    var scaleX = visual.Scale.X.ToString("F3", CultureInfo.InvariantCulture);
                    var scaleY = visual.Scale.Y.ToString("F3", CultureInfo.InvariantCulture);
                    var alpha = visual.Alpha.ToString("F2", CultureInfo.InvariantCulture);
                    var posX = (visual.Position.X * Match3GameService.CellSize).ToString("F1", CultureInfo.InvariantCulture);
                    var posY = (visual.Position.Y * Match3GameService.CellSize).ToString("F1", CultureInfo.InvariantCulture);

                    <div @key="kvp.Key" class="tile"
                         style="transform: translate(@(posX)px, @(posY)px) scale(@scaleX, @scaleY); opacity: @alpha;"
                         draggable="false"
                         @ondragstart:preventDefault
                         @onpointerdown="e => HandlePointerDown(e, (int)Math.Round(visual.Position.X), (int)Math.Round(visual.Position.Y))"
                         @onpointerup="HandlePointerUp"
                         @onpointerdown:stopPropagation>
                         <div class="tile-inner">
                            <span class="tile-base">@GetTileIcon(visual)</span>
                         </div>
                    </div>
                }
            }

            <!-- Active Projectiles -->
            @foreach (var kvp in GameService.VisualState.Projectiles)
            {
                var p = kvp.Value;
                if (p.IsVisible)
                {
                    var posX = (p.Position.X * Match3GameService.CellSize).ToString("F1", CultureInfo.InvariantCulture);
                    var posY = (p.Position.Y * Match3GameService.CellSize).ToString("F1", CultureInfo.InvariantCulture);
                    var rot = p.Rotation.ToString("F1", CultureInfo.InvariantCulture);

                    <div @key="p.Id" class="projectile"
                         style="transform: translate(@(posX)px, @(posY)px) rotate(@(rot)deg);">
                        <div class="projectile-inner">ðŸ›¸</div>
                    </div>
                }
            }

            <!-- Selection Indicator -->
            @if (GameService.SimulationEngine != null)
            {
                var selected = GameService.SimulationEngine.State.SelectedPosition;
                @if (selected.X >= 0 && selected.Y >= 0)
                {
                    var selX = (selected.X * Match3GameService.CellSize).ToString("F1", CultureInfo.InvariantCulture);
                    var selY = (selected.Y * Match3GameService.CellSize).ToString("F1", CultureInfo.InvariantCulture);
                    <div class="selection-indicator"
                         style="transform: translate(@(selX)px, @(selY)px);">
                    </div>
                }
            }

            <!-- Visual Effects -->
            @foreach (var effect in GameService.VisualState.Effects)
            {
                 var posX = (effect.Position.X * Match3GameService.CellSize).ToString("F1", CultureInfo.InvariantCulture);
                 var posY = (effect.Position.Y * Match3GameService.CellSize).ToString("F1", CultureInfo.InvariantCulture);
                 var opacity = (1f - effect.Progress).ToString("F2", CultureInfo.InvariantCulture);
                 
                 <div class="visual-effect @effect.EffectType"
                      style="transform: translate(@(posX)px, @(posY)px); opacity: @opacity;">
                     @if (effect.EffectType.Contains("explosion") || effect.EffectType.Contains("hit")) 
                     {
                         <span>ðŸ’¥</span>
                     }
                     else if (effect.EffectType.Contains("pop") || effect.EffectType.Contains("highlight"))
                     {
                         <span>âœ¨</span>
                     }
                     else 
                     {
                         <span>âœ¨</span>
                     }
                 </div>
            }
        </div>
    </div>
}
else
{
    <div class="loading">Loading Board...</div>
}
