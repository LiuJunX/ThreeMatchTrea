# 关卡设计指南

<!-- SOURCE_OF_TRUTH: level-design -->

本文档定义关卡设计的规范和原则，供 AI 和策划参考。

---

## 1. 关卡配置格式

```json
{
  "id": "level_001",
  "width": 9,
  "height": 9,
  "moves": 25,
  "colorCount": 5,
  "goals": [
    { "type": "collect", "tileType": "red", "count": 30 }
  ],
  "initialBoard": [],
  "blockers": [],
  "spawners": [],
  "boardShape": "rectangle"
}
```

### 核心字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | string | ✓ | 关卡唯一标识 |
| width | int | ✓ | 棋盘宽度 (5-11) |
| height | int | ✓ | 棋盘高度 (5-11) |
| moves | int | ✓ | 步数限制 |
| colorCount | int | ✓ | 颜色种类数 (4-7) |
| goals | array | ✓ | 通关目标（最多 3 个） |
| initialBoard | array | | 初始棋盘布局 |
| blockers | array | | 障碍物配置 |
| spawners | array | | 生成点配置 |
| boardShape | string | | 棋盘形状，默认 rectangle |

### 元数据字段（可选）

| 字段 | 类型 | 说明 |
|------|------|------|
| title | string | 关卡显示名称 |
| category | string | 分类：tutorial / normal / challenge / boss |
| difficulty | string | 难度标签：easy / medium / hard / very_hard |
| hint | string | 提示文案 |
| designNotes | string | 设计意图说明（仅供内部参考） |

---

## 2. 棋盘形状设计

### 2.1 形状类型

| 形状 | 特点 | 适用场景 |
|------|------|----------|
| rectangle | 标准矩形，流动均匀 | 通用、教学 |
| cross | 十字形，中央汇聚 | 中等难度，制造焦点 |
| diamond | 菱形，边角难处理 | 中高难度 |
| L-shape | L形，两个区域 | 分区挑战 |
| hourglass | 沙漏形，中间瓶颈 | 高难度，控制流动 |
| compartment | 多房间，独立区域 | 复杂策略关 |

### 2.2 形状对难度的影响

```
宽阔区域 → 容易连锁 → 简单
狭窄通道 → 瓶颈堵塞 → 困难
边角位置 → 难以消除 → 重点障碍区
中央位置 → 容易波及 → 放置核心目标
```

### 2.3 形状设计原则

- 瓶颈处不要放多层障碍物（会造成死局）
- 每个独立区域都要有生成点
- 避免出现"死角"（完全无法影响的格子）
- 形状复杂度应与关卡序号正相关

---

## 3. 颜色数量设计

| 颜色数 | 特点 | 适用场景 |
|--------|------|----------|
| 4 色 | 频繁连锁，爽快感强 | 教学、简单、休息关 |
| 5 色 | 标准难度，平衡 | 大部分关卡 |
| 6 色 | 匹配困难，需要规划 | 中高难度 |
| 7 色 | 极难自然匹配 | Boss 关、特殊挑战 |

**原则**：颜色数是最直接的难度调节手段，优先于调整步数。

---

## 4. 目标类型

### 4.1 基础目标

| type | 说明 | 难度贡献 |
|------|------|----------|
| collect | 收集指定颜色元素 | 低-中 |
| clear | 清除指定障碍物 | 中-高 |
| drop | 掉落物品到底部 | 中-高 |
| score | 达到目标分数 | 低 |

### 4.2 进阶目标

| type | 说明 | 难度贡献 |
|------|------|----------|
| combo | 制造 N 个特殊道具 | 中 |
| chain | 达成 N 连锁 | 中-高 |
| rescue | 解救被困元素 | 高 |

### 4.3 目标组合原则

| 组合 | 效果 |
|------|------|
| 单目标 | 清晰聚焦，适合教学 |
| 双目标（同向） | 如：清冰块 + 收集冰块下的元素，自然协同 |
| 双目标（中立） | 如：收集红 + 收集蓝，分配注意力 |
| 双目标（冲突） | 如：收集红 + 限制区域有红，需要权衡 |
| 三目标 | 高复杂度，仅用于后期关卡 |

**禁忌**：避免设计相互矛盾的目标（如同时需要保留和消除同一区域）

---

## 5. 障碍物设计

### 5.1 障碍物类型

| 类型 | 行为 | 层数 | 消除方式 |
|------|------|------|----------|
| ice | 覆盖元素，消除时减层 | 1-3 | 匹配、炸弹 |
| stone | 完全阻挡，不可穿透 | 1 | 仅炸弹 |
| cage | 锁住元素，不可移动 | 1-2 | 匹配、炸弹 |
| chain | 连接相邻格，一起消除才有效 | 1-3 | 同时匹配 |
| chocolate | 蔓延型，每回合扩张 | - | 相邻匹配 |
| honey | 粘性，元素无法移动 | 1-2 | 匹配、炸弹 |
| portal | 传送元素到另一位置 | - | 不可消除 |
| conveyor | 每回合移动元素 | - | 不可消除 |

### 5.2 障碍物难度系数

```
基础障碍：ice(1层) = 1.0
多层障碍：ice(3层) = 2.5（非线性增长）
阻挡障碍：stone = 3.0（必须用炸弹）
蔓延障碍：chocolate = 4.0（时间压力）
```

### 5.3 位置配置格式

障碍物的 `positions` 字段支持两种格式：

**精确坐标**（适合精细控制）：
```json
"positions": [[3,3], [4,3], [5,3], [3,4], [4,4]]
```

**预设模式**（适合快速设计）：
```json
"positions": "center_3x3"      // 中央 3x3 区域
"positions": "border"          // 边缘一圈
"positions": "corners"         // 四个角落
"positions": "scattered_20"    // 随机分散 20 个位置
"positions": "top_half"        // 上半部分
```

### 5.4 障碍物放置原则

**宜**：
- 将多层障碍放在连锁容易波及的位置
- 用阻挡障碍创造"房间"分隔
- 蔓延障碍放在角落（给玩家反应时间）

**忌**：
- 堵住唯一的生成点
- 在瓶颈处堆叠障碍
- 首次引入时就用最高层数
- 多种障碍物混杂造成视觉混乱

---

## 6. 步数经济学

### 6.1 步数计算公式

```
基础步数 = Σ(目标数量 × 目标系数) + Σ(障碍层数 × 障碍系数)
推荐步数 = 基础步数 × 难度系数 × 1.3
```

### 6.2 难度系数参考

| 难度 | 系数 | 目标通关率 |
|------|------|------------|
| 简单 | 1.5 | 90%+ |
| 普通 | 1.3 | 75-85% |
| 困难 | 1.1 | 60-75% |
| 挑战 | 1.0 | 40-60% |

### 6.3 步数微调原则

- 步数是最后调整的参数
- 先固定关卡设计，再通过模拟确定步数
- 宁多勿少：玩家剩余步数会转化为奖励分数，体验好

---

## 7. 特殊道具经济

### 7.1 道具生成条件

| 道具 | 条件 | 基础概率 |
|------|------|----------|
| 横向火箭 | 4 横消 | 高 |
| 纵向火箭 | 4 纵消 | 高 |
| 炸弹 | T/L 形消除 | 中 |
| 彩虹球 | 5 连消 | 低 |
| UFO | 2×2 方形 | 中 |

### 7.2 关卡应提供的道具机会

| 关卡难度 | 应保证的道具机会 |
|----------|------------------|
| 简单 | 自然出现 4 消 |
| 普通 | 可以制造 T/L |
| 困难 | 5 消是可能的但需规划 |
| 挑战 | 需要组合道具 |

### 7.3 道具依赖设计

- 如果关卡**必须**靠道具才能过，要确保道具**可以**被制造出来
- 不要让玩家依赖运气生成特定道具
- 提供多条通关路径

---

## 8. 连锁设计

### 8.1 连锁与棋盘的关系

| 棋盘特征 | 连锁倾向 |
|----------|----------|
| 高瘦棋盘 | 连锁多（下落距离长） |
| 矮宽棋盘 | 连锁少 |
| 多生成点 | 连锁多 |
| 瓶颈形状 | 连锁被打断 |

### 8.2 连锁数量建议

| 目标体验 | 平均连锁/步 |
|----------|-------------|
| 爽快 | 1.5-2.0 |
| 平衡 | 1.0-1.5 |
| 策略 | 0.5-1.0 |

### 8.3 连锁控制

- 过多连锁 → 游戏感觉像老虎机，策略感低
- 过少连锁 → 游戏感觉枯燥，成就感低
- 目标：让玩家感觉"我预判到了这个连锁"

---

## 9. 情感曲线设计

### 9.1 单关卡情感曲线

```
开局(1-5步)     → 建立信心，明确方向
中盘(6-15步)    → 核心挑战，压力上升
转折(16-20步)   → 关键决策点
收尾(21-25步)   → 紧张或从容，取决于设计意图
```

### 9.2 情感类型

| 类型 | 设计方式 | 玩家感受 |
|------|----------|----------|
| 碾压局 | 步数充裕，目标简单 | 放松、自信 |
| 规划局 | 步数紧张但足够，需策略 | 专注、成就感 |
| 惊险局 | 最后几步完成目标 | 紧张、兴奋 |
| 翻盘局 | 靠连锁/道具逆转 | 惊喜、爽快 |
| 遗憾局 | 差一点点失败 | 不甘心、想重试 |

**好的关卡应该制造"惊险局"和"翻盘局"，避免"碾压局"和"无望局"**

### 9.3 跨关卡节奏

```
每 10 关安排：
- 7 关普通难度（规划局）
- 2 关较难（惊险局/遗憾局）
- 1 关简单（碾压局，休息）
```

---

## 10. 教学关设计

### 10.1 机制引入顺序

| 关卡区间 | 引入机制 |
|----------|----------|
| 1-5 | 基础匹配、目标概念 |
| 6-15 | 4 消道具、横竖火箭 |
| 16-25 | T/L 消除、炸弹 |
| 26-35 | 5 消、彩虹球 |
| 36-50 | 基础障碍（冰、笼子） |
| 51-70 | 道具组合 |
| 71+ | 复杂障碍、多目标 |

### 10.2 教学关原则

- **单一焦点**：一关只教一个新概念
- **必然触发**：设计让玩家一定会用到新机制
- **容错空间**：教学关步数多 50%
- **即时反馈**：新机制使用后立刻看到效果

### 10.3 教学关示例

```json
{
  "id": "tutorial_rocket",
  "title": "火箭教学",
  "width": 7,
  "height": 7,
  "moves": 20,
  "colorCount": 4,
  "goals": [
    { "type": "collect", "tileType": "red", "count": 20 }
  ],
  "initialBoard": [
    ["_", "_", "_", "red", "_", "_", "_"],
    ["_", "_", "_", "red", "_", "_", "_"],
    ["_", "_", "_", "red", "_", "_", "_"],
    ["_", "_", "_", "_", "_", "_", "_"]
  ],
  "hint": "开局已摆好 3 个红色，旁边再消一个红色就能 4 消"
}
```

---

## 11. 难度曲线设计

### 11.1 宏观难度曲线

```
难度
  │
  │         ╱╲    ╱╲
  │    ╱╲  ╱  ╲  ╱  ╲   ╱ →
  │   ╱  ╲╱    ╲╱    ╲ ╱
  │  ╱
  │ ╱
  └─────────────────────── 关卡
    1   20   50   100   200
```

特征：
- 整体上升趋势
- 有波动（避免单调）
- 每 10-15 关有一个局部峰值
- 峰值后有回落（休息关）

### 11.2 难度锚点

| 关卡 | 定位 | 设计目标 |
|------|------|----------|
| 10 | 首个小高峰 | 测试玩家是否掌握基础 |
| 25 | 道具检验 | 必须会用道具才能过 |
| 50 | 中期门槛 | 区分休闲/核心玩家 |
| 100 | 里程碑 | 有仪式感的挑战 |

---

## 12. 设计禁忌

### 12.1 严重问题（必须避免）

| 禁忌 | 后果 |
|------|------|
| 开局无解 | 玩家立即流失 |
| 目标不可完成 | 无限重试，差评 |
| 纯运气通关 | 挫败感，感觉不公平 |
| 颜色饥荒 | 目标色不生成，无能为力 |

### 12.2 体验问题（应该避免）

| 禁忌 | 后果 |
|------|------|
| 目标不可见 | 玩家迷茫 |
| 视觉混乱 | 无法规划 |
| 无事可做 | 等待生成，无聊 |
| 无成就感 | 机械操作，脱离 |

### 12.3 设计偏见（需要警惕）

| 问题 | 说明 |
|------|------|
| 设计者诅咒 | 设计者知道解法，误以为玩家也知道 |
| 复杂度堆砌 | 多不等于好 |
| 数值膨胀 | 目标 30 和 300 体验相同 |

---

## 13. 测试与迭代

### 13.1 测试指标

| 指标 | 健康范围 | 异常信号 |
|------|----------|----------|
| 首次通关率 | 60-80% | <50% 太难，>90% 太简单 |
| 平均尝试次数 | 1.2-2.0 | >3 需要降难度 |
| 平均用时 | 2-4 分钟 | >5 分钟可能卡住了 |
| 步数使用率 | 70-95% | <60% 太简单 |
| 道具使用率 | 30-50% | >70% 可能太依赖道具 |

### 13.2 AB 测试场景

- 不确定难度时，准备 A/B 两版步数
- 新障碍物引入时，测试不同放置方案
- 目标数量调整时，测试玩家反馈

### 13.3 迭代原则

1. 先调步数（成本最低）
2. 再调颜色数（影响中等）
3. 然后调目标数量
4. 最后调障碍物布局（成本最高）

---

## 14. 示例关卡库

### 14.1 教学关：基础匹配

```json
{
  "id": "tutorial_001",
  "category": "tutorial",
  "difficulty": "easy",
  "width": 7,
  "height": 7,
  "moves": 15,
  "colorCount": 4,
  "goals": [
    { "type": "collect", "tileType": "red", "count": 10 }
  ],
  "designNotes": "无障碍，低目标，让玩家熟悉滑动操作和基本匹配"
}
```

### 14.2 教学关：首次引入冰块

```json
{
  "id": "tutorial_ice",
  "category": "tutorial",
  "difficulty": "easy",
  "width": 9,
  "height": 9,
  "moves": 30,
  "colorCount": 5,
  "goals": [
    { "type": "clear", "blockerType": "ice", "count": 9 }
  ],
  "blockers": [
    { "type": "ice", "positions": [[3,3], [4,3], [5,3], [3,4], [4,4], [5,4], [3,5], [4,5], [5,5]], "layers": 1 }
  ],
  "designNotes": "冰块集中放置在中央 3x3 区域，让玩家理解'消除旁边的元素可以打破冰块'"
}
```

### 14.3 普通关：双目标

```json
{
  "id": "level_045",
  "category": "normal",
  "difficulty": "medium",
  "width": 9,
  "height": 9,
  "moves": 28,
  "colorCount": 5,
  "goals": [
    { "type": "collect", "tileType": "blue", "count": 35 },
    { "type": "clear", "blockerType": "ice", "count": 20 }
  ],
  "blockers": [
    { "type": "ice", "positions": "scattered_20", "layers": 1 }
  ],
  "designNotes": "双目标但协同：消冰的同时自然收集蓝色。冰块分散放置，避免集中难点"
}
```

### 14.4 困难关：瓶颈地形

```json
{
  "id": "level_088",
  "category": "challenge",
  "difficulty": "hard",
  "width": 9,
  "height": 11,
  "moves": 35,
  "colorCount": 6,
  "boardShape": "hourglass",
  "goals": [
    { "type": "drop", "itemType": "cherry", "count": 5 }
  ],
  "spawners": [
    { "position": [4, 0], "spawnType": "cherry", "probability": 0.1 }
  ],
  "designNotes": "沙漏形地形，中间瓶颈只有 3 格宽。樱桃从顶部生成，需要引导到底部。关键是不要让瓶颈堵死"
}
```

### 14.5 Boss 关：多层障碍 + 多目标

```json
{
  "id": "boss_100",
  "category": "boss",
  "difficulty": "very_hard",
  "width": 9,
  "height": 9,
  "moves": 45,
  "colorCount": 5,
  "goals": [
    { "type": "clear", "blockerType": "ice", "count": 25 },
    { "type": "clear", "blockerType": "stone", "count": 8 },
    { "type": "collect", "tileType": "red", "count": 50 }
  ],
  "blockers": [
    { "type": "ice", "positions": "border", "layers": 3 },
    { "type": "stone", "positions": "corners_and_center" }
  ],
  "designNotes": "第 100 关里程碑。三层冰包围边缘，石头在四角和中心形成十字。需要用炸弹开路，策略性强。步数充裕但需要规划"
}
```

---

## 15. 待补充

- [ ] 特殊关卡类型（限时关、无尽模式）
- [ ] 赛季/活动关卡设计
- [ ] 具体障碍物的详细参数
- [ ] 实际项目中的成功/失败案例
- [ ] 策划反馈沉淀的经验

---

*本文档基于三消游戏通用设计原则编写，需根据实际产品特性调整。持续记录策划与 AI 协作过程中的设计经验。*
