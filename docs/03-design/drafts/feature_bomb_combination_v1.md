# 核心玩法需求：炸弹合成 (Bomb Combination)

| 文档状态 | 作者 | 日期 | 对应版本 |
| :--- | :--- | :--- | :--- |
| Draft | Senior Game Planner | 2026-01-11 | v1.0 |

## 1. 背景与目标 (Context & Goals)

### 1.1 设计意图
在三消游戏中，炸弹合成（即交换两个相邻的特殊道具）是爽感爆发的核心时刻。它体现了“1+1 > 2”的设计哲学，奖励玩家的策略布局。

### 1.2 竞品分析：Royal Match
Royal Match (RM) 是目前的行业标杆，其炸弹合成设计具有以下特点：
*   **清晰的视觉反馈**：每种组合都有独特的动画预演和爆发效果。
*   **全矩阵覆盖**：任意两种道具组合都会触发特殊效果，无死角。
*   **强力清屏感**：特别是彩虹球（Light Ball）的组合，能瞬间改变盘面局势。

**RM 组合效果分析：**
1.  **Rocket + Rocket**: 十字消除（Cross）。
2.  **Rocket + TNT**: 三排十字消除（3-line Cross）。
3.  **TNT + TNT**: 大范围爆炸（Big Boom, usually 5x5 or larger radius）。
4.  **Rocket/TNT + Propeller**: 螺旋桨先飞到目标点，然后在该点触发Rocket/TNT效果。这是RM的一个亮点，增加了精确打击能力。
5.  **Light Ball + Rocket/TNT/Propeller**: 将全场同色棋子转化为对应的特殊道具，并引发连锁爆炸。
6.  **Light Ball + Light Ball**: 全屏清除。

**优劣势总结：**
*   **优**：规则简单统一，反馈极强，策略深度足够（特别是螺旋桨组合的精确打击）。
*   **劣**：彩虹球组合运算量大，动画时间长（但这是爽感必要的代价）。

---

## 2. 需求定义 (Requirements)

基于 RM 的成功经验，结合我们要开发的 Match-3 引擎，制定以下合成规则。

### 2.1 基础炸弹类型定义 (Bomb Types)

首先明确我们游戏中的四种基础特殊道具（对应代码 `BombType`）：

| 图标 (参考) | 名称 | 代码映射 | 生成条件 | 基础效果 |
| :--- | :--- | :--- | :--- | :--- |
| 🚀 | **直线炸弹 (Rocket)** | `BombType.Horizontal` / `Vertical` | 4连消 | 清除一行或一列 |
| 💣 | **区域炸弹 (TNT)** | `BombType.Area` / `Square3x3` | T型/L型 5消 | 清除 3x3 (或更大) 区域 |
| 🛸 | **追踪导弹 (UFO)** | `BombType.Ufo` | 田字型 4消 | 清除自身 + 飞向1个目标造成伤害 |
| 🌈 | **彩虹球 (Rainbow)** | `TileType.Rainbow` (BombType.Color) | 5连消 | 清除全场指定颜色 |

### 2.2 合成矩阵 (Combination Matrix)

当玩家交换两个相邻的特殊道具时，**不触发普通交换逻辑，而是触发以下合成效果**：

#### A. 直线炸弹组合 (Rocket Combos)
*   **Rocket + Rocket**:
    *   **效果**：以交换点为中心，同时清除 **1行 + 1列**（十字消除）。
    *   **表现**：两枚火箭合并，分别向四个方向发射。

*   **Rocket + TNT**:
    *   **效果**：以交换点为中心，清除 **3行 + 3列** 的十字区域。
    *   **表现**：变成巨大的火箭，横扫宽阔区域。

*   **Rocket + UFO**:
    *   **效果**：UFO 随机选择一个目标（优先选择关卡目标），飞过去后，在该位置变成 **Rocket** 并立即激活。
    *   **注意**：原来的 Rocket 和 UFO 在原位消失。
    *   **策略**：用于远程打击特定行列。

#### B. 区域炸弹组合 (TNT Combos)
*   **TNT + TNT**:
    *   **效果**：产生超大范围爆炸。建议范围为 **5x5** 或 **7x7**（普通TNT通常为3x3）。
    *   **表现**：巨大的冲击波，震动屏幕。

*   **TNT + UFO**:
    *   **效果**：UFO 飞向目标点，在该位置变成 **TNT** 并激活。
    *   **策略**：远程爆破难缠的障碍物。

#### C. 追踪导弹组合 (UFO Combos)
*   **UFO + UFO**:
    *   **效果**：发射 **3枚**（或更多）追踪导弹，分别打击不同的目标。
    *   **RM参考**：RM是产生3个螺旋桨。我们可以设定为产生 3-5 个追踪弹。

#### D. 彩虹球组合 (Rainbow Combos) - *终极爽感*
*   **Rainbow + Rocket**:
    *   **效果**：将场上所有 **该颜色的普通棋子** 变为 **Rocket**（随机方向），然后**依次引爆**它们。
    *   **表现**：先变化，停顿0.5秒让玩家看清，然后“噼里啪啦”连锁引爆。

*   **Rainbow + TNT**:
    *   **效果**：将场上所有 **该颜色的普通棋子** 变为 **TNT**，然后**依次引爆**。
    *   **风险**：性能消耗大，需分批引爆或优化动画。

*   **Rainbow + UFO**:
    *   **效果**：将场上所有 **该颜色的普通棋子** 变为 **UFO**，然后全部起飞寻找目标。
    *   **表现**：漫天飞碟，非常壮观。

*   **Rainbow + Rainbow**:
    *   **效果**：**清空全屏**（清除所有层级的障碍物一层）。
    *   **表现**：强烈的白光或冲击波扫过全屏。

---

## 3. 表现与反馈 (Visual & Audio)

*   **预判高亮**：当玩家选中一个炸弹，并拖拽指向另一个炸弹时（未松手），两个炸弹应放大/发光，提示可以合成。
*   **顿帧 (Hit Stop)**：合成触发瞬间，游戏轻微停顿 (0.1s)，给予打击感。
*   **相机震动**：
    *   Rocket/UFO：轻微震动。
    *   TNT/Combo：中度震动。
    *   Rainbow Combo：强烈震动。
*   **优先级**：合成效果的动画优先级最高，必须阻断掉落，直到效果播放完毕。

---

## 4. 技术可行性与风险 (Technical Feasibility)

### 4.1 现有代码支持
*   `BombType` 枚举已存在基础定义，但需确认 `Ufo` 的具体逻辑实现。
*   `PowerUpHandler.cs` 中的 `ProcessSpecialMove` 是入口。
*   目前代码中 `TryHandleBombCombo` 逻辑较简单（只区分了行列和区域），需要重写以支持上述全矩阵。

### 4.2 开发任务拆解
1.  **Core**: 扩展 `PowerUpHandler`，实现上述特定的组合逻辑（特别是 UFO 的远程投递逻辑）。
2.  **View**: 增加对应的特效播放接口。目前 `IGameView` 可能需要扩展 `PlayBoneComboEffect` 之类的方法。
3.  **Config**: 各种爆炸范围、UFO 数量需配置化 (`GameConfig`)。

### 4.3 风险点
*   **Rainbow + TNT** 的连锁爆炸极易导致掉帧或逻辑卡死（无限循环）。
    *   *解决方案*：设定引爆队列，不要一帧内全部引爆；或者逻辑上一次性结算，表现上分批播放。
*   **UFO 寻路**：需要 `GridSystem` 提供可靠的“价值目标”查找算法（优先打草地、箱子等）。

---

> 请开发团队评估上述需求，特别是 UFO 组合的实现成本。
