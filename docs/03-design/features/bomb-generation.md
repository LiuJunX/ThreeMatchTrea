# 核心机制：炸弹生成规则 (Bomb Generation)

| 文档状态 | 作者 | 日期 | 对应版本 |
| :--- | :--- | :--- | :--- |
| **Implemented** | Senior Game Planner & AI Assistant | 2026-01-12 | v1.0 (Core Implemented) |

## 1. 生成规则总览 (Overview)

本游戏遵循“形状决定功能”的原则。以下是核心生成逻辑的速查表：

| 图标 | 名称 | 形状要求 | 关键特征 |
| :---: | :--- | :--- | :--- |
| 🚀 | **火箭 (Rocket)** | **直线 4** (Line 4) | 清除整行/整列 |
| 🛸 | **螺旋桨 (UFO)** | **正方形** (Square 2x2) | 自动追踪打击 |
| 💣 | **炸弹 (TNT)** | **T型 / L型** (5+) | 区域爆破 |
| 🌈 | **彩虹球 (Rainbow)** | **直线 5** (Line 5) | 全屏同色清除 |

---

## 2. 生成位置判定通用规则 (Spawn Position Logic)

为了给玩家提供最精准的控制感，炸弹生成的坐标判定至关重要。

### 核心原则：操作优先 (Input Priority)
当玩家交换两个棋子（A 和 B）导致消除时，系统需判断**哪一个格子**生成炸弹。
判定逻辑如下（优先级从高到低）：

1.  **优先级 1：玩家操作位 (Player Input Positions)**
    *   **定义**：玩家刚才交换的两个格子（**起点 Source** 和 **终点 Target**）拥有同等且最高的优先级。
    *   **规则**：只要当前的消除组中包含这两个格子中的**任意一个**，炸弹就必须生成在该格子上。
    *   *场景*：
        *   **常规消除**：玩家拖拽 A 到 B，B 处形成消除 -> 生成在 B。
        *   **异位消除**：玩家拖拽 A 到 B，A 的原位（被新棋子填充）形成消除 -> 生成在 A 的原位。
    *   *目的*：确保炸弹始终生成在玩家“手指触碰过”的地方，提供最强的操控反馈。

2.  **优先级 2：随机位置 (Random Position)**
    *   **定义**：在消除组的所有格子中随机选择一个。
    *   **场景**：非玩家直接操作导致的消除（如掉落连击、连锁反应）。
    *   *规则*：完全随机，**不需要**倾向于中心点。

---

## 3. 炸弹生成图谱 (Bomb Patterns)

**注意**：以下图示仅展示**触发炸弹生成的几何形状**。
*   `A` 代表参与消除的同色棋子。
*   图形的**旋转**（90°/180°/270°）和**镜像/对称**形态均遵循相同的生成规则。
*   **生成位置**：具体生成在哪个格子，请遵循“第2章 生成位置判定规则”（优先玩家操作位，其次随机）。

### 3.1 火箭 (Rocket)
**触发条件**：单行或单列连续 **4个** 同色棋子。

```text
   形状 1: 横向四连 (Horizontal Line 4)
   -------------------------
   [A] [A] [A] [A]
   -------------------------
   结果: 生成【纵向火箭】(清除整列)
```

```text
   形状 2: 竖向四连 (Vertical Line 4)
   -------------------------
   [A]
   [A]
   [A]
   [A]
   -------------------------
   结果: 生成【横向火箭】(清除整行)
```

---

### 3.2 螺旋桨 (UFO / Propeller)
**触发条件**：形成 **2x2** 的正方形区域（共4个）。

```text
   形状: 标准田字格 (Square 2x2)
   -------------------------
   [A] [A]
   [A] [A]
   -------------------------
   结果: 生成【螺旋桨】
```

### 3.3 炸弹 (TNT)
**触发条件**：
1.  **T型** 或 **L型** 连续 **5个及以上** 同色棋子。
2.  **十字型 (Plus Shape)**：由横竖两组 3连 交叉构成（共5个），视为特殊的 T型，同样生成 TNT。

```text
   形状 1: L型 (L-Shape)
   -------------------------
   [A]
   [A]
   [A] [A] [A]
   -------------------------
   结果: 生成【炸弹】
```

```text
   形状 2: T型 (T-Shape)
   -------------------------
   [A] [A] [A]
       [A]
       [A]
   -------------------------
   结果: 生成【炸弹】
```

---

### 3.4 彩虹球 (Rainbow / Light Ball)
**触发条件**：单行或单列连续 **5个及以上** 同色棋子。

```text
   形状: 直线五连 (Line 5)
   -------------------------
   [A] [A] [A] [A] [A]
   -------------------------
   结果: 生成【彩虹球】
```

---

## 4. 巨型消除与多重生成策略 (Mega Matches & Multi-Spawn)

对于涉及大量棋子的复杂消除（例如 6x6 区域），系统不再局限于“单次消除只生成一个炸弹”，而是采用**“全局最优拆分” (Global Optimal Partitioning)** 策略，以确保玩家利益最大化，避免“反常识”的浪费。

### 4.1 判定逻辑：三步走 (The 3-Step Process)

为确保逻辑清晰，采用以下流程处理复杂消除：

```mermaid
graph TD
    A[开始: 检测到消除连通域] --> B[识别所有候选形状]
    B --> C{有形状重叠?}
    C -- 无重叠 --> D[直接生成所有对应炸弹]
    C -- 有重叠 --> E[计算组合权重]
    E --> F[选择总权重最高的非冲突组合]
    F --> G[应用: 形状亲和性 (包含操作点优先)]
    G --> H[确定最终炸弹列表]
    H --> I[执行: 散点吸附机制]
    I --> J[结束: 生成炸弹]
```

1.  **全量检测 (Detect All)**：
    *   识别当前消除组中**所有**符合条件的几何形状（允许重叠）。
    *   **关键定义**：检测器应寻找**最小有效子结构** (Minimal Valid Substructures)。例如在 6 个连成一线的棋子中，应识别出 3 个“4连火箭”的候选位置，而不是只识别一个。
    *   例如：在一个 2x4 的区域中，可能会识别出 3 个 2x2 的正方形（左、中、右）。

2.  **权重赋值 (Scoring)**：
    *   为每个形状分配权重：**彩虹球(130) > 炸弹(60) > 火箭(40) > 螺旋桨(20)**。
    *   *注*：彩虹球权重设为 130，既高于“双炸弹”组合（120分），又保留了极少数“三炸弹”组合（如 2TNT+UFO=140）反超的可能性。
    *   *注*：螺旋桨(UFO)权重较低是为了平衡其极易触发(2x2)的特性，防止满屏乱飞。

3.  **最优择取 (Optimal Selection)**：
    *   在所有候选中，选择一组**互不冲突**（不共用棋子）的组合，使得**总权重最高**。
    *   *原则*：宁可生成两个低级炸弹，也不要因为贪婪而破坏了整体结构导致只生成一个。

### 4.2 典型案例演练 (Case Studies)

#### 案例 A：带“背包”的长条 (User's Case)
**形状**：底部 5 个横排，顶部左侧 2 个（类似手枪型，共 7 个）。
```
    [A] [A]
    [A] [A] [A] [A] [A]
```
*   **候选分析**：
    1.  **彩虹球** (底部5连)：权重 130。消耗底部 5 个。
    2.  **火箭** (底部4连)：权重 40。消耗底部 4 个。
    3.  **螺旋桨** (左侧2x2)：权重 20。消耗左侧 4 个。
*   **组合博弈**：
    *   方案 1：选彩虹球 -> 剩余顶部 2 个（无法生成）。总分 **130**。
    *   方案 2：选螺旋桨 -> 剩余右侧 3 个（无法生成）。总分 **20**。
    *   方案 3：选火箭 -> 剩余 3 个。总分 **40**。
*   **最终结果**：**生成 1 个彩虹球**。（价值 130 分，碾压其他选项）

#### 案例 B：2x4 矩形 (The 2x4 Trap)
**形状**：2 行 4 列，共 8 个。
```
    [A] [A] [A] [A]
    [A] [A] [A] [A]
```
*   **候选分析**：
    *   **螺旋桨组**：左侧 2x2 (UFO-L, 20分)，右侧 2x2 (UFO-R, 20分)。
    *   **火箭组**：第一行 4连 (Rocket-Top, 40分)，第二行 4连 (Rocket-Bottom, 40分)。
*   **最优拆分**：
    *   **组合 1 (全螺旋桨)**：{ UFO-L, UFO-R } -> 互不冲突。总分 20 + 20 = **40**。
    *   **组合 2 (全火箭)**：{ Rocket-Top, Rocket-Bottom } -> 互不冲突。总分 40 + 40 = **80**。
*   **最终结果**：**生成 2 个横向火箭**。
    *   *变化说明*：由于您将火箭的权重 (40) 调整为高于螺旋桨 (20)，系统判定生成两个火箭的收益 (80) 远大于两个螺旋桨 (40)。这与之前的逻辑（生成螺旋桨）截然不同，体现了权重调整对策略的直接影响。

#### 案例 C：6x6 巨型方块
*   **逻辑**：系统会优先“切”出尽量多的彩虹球（5连），剩下的残羹冷炙再切成火箭或螺旋桨。
*   **预期**：6~7 个彩虹球 + 若干火箭（因为火箭权重 > 螺旋桨，剩下的散块如果能凑成4连会优先变火箭）。

### 4.3 优先级阶梯 (Weight Table)
在计算总权重时参考：

| 炸弹类型 | 权重 | 说明 |
| :--- | :--- | :--- |
| Rainbow | 130 | 绝对优先，但允许被 2x TNT + 1x UFO (140) 超越 |
| TNT | 60 | 明显高于火箭，确保 T/L 形状优先生成炸弹 |
| Rocket | 40 | 高于 UFO，确保 2x4 生成双火箭 |
| UFO | 20 | 最低，仅作为填充 |

---

## 5. 技术实现 (Technical Implementation)

### 5.1 零分配架构 (Zero Allocation Architecture)
为了满足游戏循环的性能要求，本系统在 **Hot Path** 中实现了完全的**零内存分配 (Zero Allocation)**。

*   **对象池 (Object Pooling)**:
    *   使用 `Pools.Obtain<T>` 和 `Pools.Release<T>` 管理所有临时对象。
    *   包括 `List<T>`, `HashSet<T>`, `Dictionary<K,V>`, 以及自定义类 `DetectedShape`。
    *   `DetectedShape` 内部的 `Cells` 集合也是池化的，使用完毕后显式归还。
*   **结构体优化**:
    *   大量使用 `Position` (struct) 进行坐标传递，避免装箱。
*   **安全释放**:
    *   所有池化资源的使用都包裹在 strict `try/finally` 块中，确保即使发生异常也能正确归还资源，防止内存泄漏。

### 5.2 核心算法 (Core Algorithms)

#### 形状检测 (Shape Detection)
*   **类**: `ShapeDetector`
*   **逻辑**: 遍历连通域中的每个点，检查其周围是否构成预定义的几何形状（直线、正方形、L/T型）。
*   **输出**: 生成所有可能的候选形状列表（允许重叠）。

#### 全局最优规划 (Global Optimal Solver)
*   **类**: `BombGenerator`
*   **逻辑**: 使用带有剪枝的**回溯算法 (Backtracking)**。
*   **冲突检测**: 使用 `BitMask` (long) 或 `HashSet` 快速检测形状之间的空间冲突。
*   **目标**: 寻找一组互不冲突的形状子集，使其总权重最大化。

#### 废料吸收 (Scrap Absorption)
*   **逻辑**: 确定最优形状组合后，剩余的未被使用的方块（Scraps）会被分配给最近的形状。
*   **算法**: 多源广度优先搜索 (Multi-Source BFS / Flood Fill)，确保所有参与消除的方块都归属于某个炸弹生成事件（用于播放动画和计算分数）。
